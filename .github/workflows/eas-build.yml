name: EAS Build and Deploy
on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build (android/ios/all)'
        required: true
        default: 'all'
        type: choice
        options:
          - android
          - ios
          - all
      profile:
        description: 'Build profile'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - preview
          - production

jobs:
  build:
    runs-on: ubuntu-latest
    name: EAS Build - ${{ github.event.inputs.platform || 'all' }}
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3
        
      - name: 🔧 Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
          
      - name: 📦 Install dependencies
        run: npm ci
        
      - name: 🔨 Install EAS CLI
        run: npm install -g eas-cli
        
      - name: 🔐 Authenticate with Expo
        run: eas whoami
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          
      - name: 📱 Build for Android
        if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all' || !github.event.inputs.platform
        run: |
          eas build --platform android \
            --profile ${{ github.event.inputs.profile || 'production' }} \
            --non-interactive \
            --wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          
      - name: 🍎 Build for iOS  
        if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all' || !github.event.inputs.platform
        run: |
          eas build --platform ios \
            --profile ${{ github.event.inputs.profile || 'production' }} \
            --non-interactive \
            --wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          
      - name: 🚀 Push OTA Update
        if: success() && (github.event.inputs.profile == 'preview' || github.event.inputs.profile == 'production' || !github.event.inputs.profile)
        run: |
          eas update --branch ${{ github.event.inputs.profile || 'production' }} \
            --message "Auto OTA update from ${{ github.sha }}"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          
      - name: 📊 List Recent Builds
        if: always()
        run: eas build:list --limit 5
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
